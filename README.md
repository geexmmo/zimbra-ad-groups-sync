# zimbra-ad-groups-sync
Is a set of scripts that can help you to synchronize AD groups Zimbra's distribution lists.

Both main scripts works different directions:    
`zimbra-to-ad.py` - will gather distribution lists including it members and will create new AD enteties based on information gathered    
`ad-to-zimbra.py` - will parse AD group information and populate Zimbra's distribution lists file accordingly.

# Requirements
## Python packages:
`pip install python-ldap`

or
	
`pip install -r requirements.txt`

## System
python-ldap may require python or ldap development headers, pip installation will fail with error if this is the case.    
    
On Debian/Ubuntu:    
 `sudo apt-get install libsasl2-dev python-dev libldap2-dev libssl-dev`

RedHat/CentOS:    
`sudo yum install python-devel openldap-devel`   

# Scripts
## settings.py
*settings.py* should be modified according to your AD setup, other scripts are heavily dependent on correct configuration supplied in this file.    
`ADdomain` is your domain DC     
`ADsearchOU` is the place where group search will be performed in ad-to-zimbra.py and group creation in zimbra-to-ad.py    
`ZimbraDumpFile` is zmprov group dump for zimbra-to-ad.py, it's creatinon will be described further in this document.    
`regexMemberCheck` is used in zimbra-to-ad.py to filter out members from domains that does not exist in AD deployment.    
      
## ad-to-zimbra.py    
ad-to-zimbra.py gets information out of AD and creates batch file for zmprov
Already existing data in zimbra will be left intact, only new groups or group memers are added.
Users without mail field are skipped.
    
>*There is a little hack in user DN search for members in OU's wich names contains special symbols in their DN, Users DN is cut to conents of it's CN part with hope that it really contains user's name, if first search fails - another one is lauched for user's 'name' field.*
    
## zimbra-to-ad.py    
zimbra-to-ad.py gets information of existing groups in Zimbra from Zimbra's zmprov dump file (ZimbraDumpFile), creation of this file described in troubleshooting part.    
ZimbraDumpFile is simply a list of existing Distribution groups and members for each group.    
Script loops trough it and tries to create similar groups populated with members in AD.


# Setup and troubleshooting
* If you are using Python's virtual environment to install python-ldap
Crontab job may fail if any of required packages or python versions is not avaiable outside virtual environment.    
Or if cron job is messed up and missing evnirnomental variables of user `zimbra`     
    


* Creating ZimbraDumpFile for zimbra-to-ad.py    
If you are planning to export current zimbra distribution lists to Active Directory:
From zimbra host as user zimbra run:    
`zmprov gadl -v > /opt/zimbra/zimbra-adgroup-sync/zimbra-test.txt`    
and then `zimbra-to-ad.py`

## Running crontab job to sync AD groups with distibution lists   
You may use this simple bash script, just change second line to match your location.    
    
>syncDL.sh example
```bash
    #!/bin/bash
    . $HOME/.bashrc
    cd /opt/zimbra/zimbra-adgroup-sync/
    source bin/activate
    python ad-to-zimbra.py
    zmprov -f ad-to-zimbra.log
```

To schedule it creatre cron job, specifying user to run as:      

>vi /etc/crontab
```
*/40 * * * * zimbra /opt/zimbra/zimbra-adgroup-sync/syncDL.sh > /opt/zimbra/zimbra-adgroup-sync/crontab.log
```


>User *zimbra* may lack neccesary permissions to create output files and logs
```bash
chown -R zimbra:zimbra /opt/zimbra/zimbra-adgroup-sync/
```

## Manually running batch file generated by ad-to-zimbra.py:
 Final result of running ad-to-zimbra.py is a ***ad-to-zimbra.log*** file, it containts commands that can be understood by and structured to be compalable with **zmprov** from zimbra distribution.

You may run batch import as *root* - or *su* into and run it as user *zimbra*

 Example as zimbra
 `zmprov -f commands.zmp`
 
 Piping whole file as root user
 `cat commands.zmp | su - zimbra -c zmprov`