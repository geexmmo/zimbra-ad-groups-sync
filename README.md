# zimbra-ad-groups-sync
Is a set of scripts that can help you to synchronize AD groups Zimbra's distribution lists.

`zimbra-to-ad.py` - will gather distribution lists including it members and will create new AD enteties based on information gathered, can be used to initiate first import of distribution list from Zimbra to AD.   
`groupsync.py`  will parse AD group information, zimbra group information, create sqlite database for each one and compare them to make some decisions and to generate batch-list of command that should be reviewed and passed in `zmprov` for execution.   
   
By defalut it tries not to gather any new information about distribution lists in Zimbra, this will result in error if this is a first run and sqlite database is not populated with distibution lists, so first run should be done with `--zm`.   
Reason for this is that it could take a lot of time to populate distibution lists database if you are having large amounts of them, and in further runs - presumes that database was one synced at initial state and was populated accordinly to updates made by script. 

# Requirements
## Python packages:
`pip install python-ldap`

or
	
`pip install -r requirements.txt`

## System
python-ldap may require python or ldap development headers, pip installation will fail with error if this is the case.    
    
On Debian/Ubuntu:    
 `sudo apt-get install libsasl2-dev python-dev libldap2-dev libssl-dev`

RedHat/CentOS:    
`sudo yum install python-devel openldap-devel`   

# Scripts
## settings.py
*settings.py* should be modified according to your AD setup, other scripts are heavily dependent on correct configuration supplied in this file.    
`ADdomain` is your domain DC     
`ADsearchOU` is the place where group search will be performed in ad-to-zimbra.py and group creation in zimbra-to-ad.py    
`ZimbraDumpFile` is batch file location, it is created by groupsync.py and should be executed by zmprov.   
Also it could be generated by zimbra and used with zimbra-to-ad.py.   
`regexMemberCheck` is used in zimbra-to-ad.py to filter out members from domains that does not exist in AD deployment.    
`IgnoredGroups` list of group that will be ignored by script. In my case it was group with external contacts that could'nt be added to AD.
    
## zimbra-to-ad.py    
zimbra-to-ad.py gets information of existing groups in Zimbra from Zimbra's zmprov dump file (ZimbraDumpFile), creation of this file described in troubleshooting part.    
ZimbraDumpFile is simply a list of existing Distribution groups and members for each group.    
Script loops trough it and tries to create similar groups populated with members in AD.   
   
* Creating ZimbraDumpFile for zimbra-to-ad.py    
If you are planning to export current zimbra distribution lists to Active Directory:
https://wiki.zimbra.com/wiki/List_all_existing_distribution_list_and_the_respective_members
This page lists commands that can be used to create ZimbraDumpFile, make sure it is named accordingly to what is declared in `ZimbraDumpFile` in settings.py.   
`zmprov gadl -v` may be broken or something, it does not list group members on some zimbra versions.   
```bash
for i in `zmprov gadl` ; do zmprov gdl $i zimbraMailAlias zimbraMailForwardingAddress ; done > /tmp/dlresult
```

## groupsync.py

Run `groupsync.py` firstly with --zm flag.   
```bash 
python3 groupsync.py --zm
```
it will start to gather distribution lists from zimbra and putting them in local sqlite database file, it may take some time so after first run `--zm` flag should not be specified, all further updates will be done in that sqlite database.   
Result of groupsync.py execution is `ZimbraDumpFile` that should be reviewed so you dont accidently delete anything important and than executed in zmprov.   
https://wiki.zimbra.com/wiki/Bulk_Provisioning
```bash
zmprov -f zimbra-dump.txt
or 
cat zimbra-dump.txt | su - zimbra -c zmprov
```

# Setup and troubleshooting
* If you are using Python's virtual environment to install python-ldap
Crontab job may fail if any of required packages or python versions is not avaiable outside virtual environment.    
Or if cron job is messed up and missing evnirnomental variables of user `zimbra`     
    


## Running crontab job to sync AD groups with distibution lists   
You may use this simple bash script, just change second line to match your location.    
    
>syncDL.sh example
```bash
    #!/bin/bash
    . $HOME/.bashrc
    cd /opt/zimbra/zimbra-adgroup-sync/
    source bin/activate
    python groupsync.py
    zmprov -f zimbra-dump.txt
```

To schedule it creatre cron job, specifying user to run as:      

>vi /etc/crontab
```
*/40 * * * * zimbra /opt/zimbra/zimbra-adgroup-sync/syncDL.sh > /opt/zimbra/zimbra-adgroup-sync/crontab.log
```


>User *zimbra* may lack neccesary permissions to create output files and logs
```bash
chown -R zimbra:zimbra /opt/zimbra/zimbra-adgroup-sync/
```